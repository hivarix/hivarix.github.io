<script>
// Initialize shared cart (same as products.html)
let cart = JSON.parse(localStorage.getItem('hivarix_cart')) || [];
const cartCountSpan = document.getElementById('cart-count');
const cartPopup = document.getElementById('cart-popup');

// Create cart items container dynamically if it doesn't exist
let cartItemsDiv = document.getElementById('cart-items');
if (!cartItemsDiv) {
  cartItemsDiv = document.createElement('div');
  cartItemsDiv.id = 'cart-items';
  cartPopup.insertBefore(cartItemsDiv, cartPopup.firstChild.nextSibling);
}

// Update cart display and save to localStorage
function updateCart() {
  localStorage.setItem('hivarix_cart', JSON.stringify(cart));
  let totalItems = cart.reduce((sum, item) => sum + item.qty, 0);
  cartCountSpan.textContent = totalItems;

  cartItemsDiv.innerHTML = '';
  if(cart.length === 0){
    cartItemsDiv.innerHTML = '<p>Your cart is empty.</p>';
    return;
  }

  cart.forEach((item, index) => {
    const div = document.createElement('div');
    div.classList.add('cart-item');
    div.style.display = 'flex';
    div.style.justifyContent = 'space-between';
    div.style.marginBottom = '10px';
    div.innerHTML = `
      <span>${item.name} (${item.qty}) - NGN ${item.price.toLocaleString()}</span>
      <button onclick="removeFromCart(${index})" style="background:red;color:#fff;border:none;padding:2px 6px;border-radius:4px;cursor:pointer;font-size:12px;">x</button>
    `;
    cartItemsDiv.appendChild(div);
  });
}

// Remove item from cart
function removeFromCart(index){
  cart.splice(index, 1);
  updateCart();
}

// Toggle cart popup
document.getElementById('cart-btn').addEventListener('click', () => {
  cartPopup.style.display = cartPopup.style.display === 'block' ? 'none' : 'block';
});
document.addEventListener('click', e => {
  if(!cartPopup.contains(e.target) && e.target !== cartBtn){
    cartPopup.style.display = 'none';
  }
});

// Checkout function
function pay(){
  if(cart.length === 0){
    alert("Your cart is empty.");
    return;
  }

  const f = firstName.value.trim();
  const l = lastName.value.trim();
  const e = email.value.trim();
  const p = phone.value.trim();
  const nigeriaPhone = /^(?:0|\+234)[789][01]\d{8}$/;

  if(!f || !l || !e || !p){
    alert("Please fill all required fields.");
    return;
  }
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)){
    alert("Please enter a valid email.");
    return;
  }
  if(!nigeriaPhone.test(p)){
    alert("Please enter a valid Nigerian phone number.");
    return;
  }

  const totalAmount = cart.reduce((sum, item) => sum + item.price * item.qty, 0);

  let handler = PaystackPop.setup({
    key: 'pk_live_532c5eee05f819c8589de72642aff146a75237dc',
    email: e,
    amount: totalAmount * 100,
    metadata: {
      custom_fields: [
        { display_name: "First Name", variable_name: "first_name", value: f },
        { display_name: "Last Name", variable_name: "last_name", value: l },
        { display_name: "Phone Number", variable_name: "phone", value: p }
      ]
    },
    callback: function(response){
      alert("Payment complete! Reference: " + response.reference);
      cart = [];
      updateCart();
      cartPopup.style.display = 'none';
      document.getElementById('firstName').value = '';
      document.getElementById('lastName').value = '';
      document.getElementById('email').value = '';
      document.getElementById('phone').value = '';
      window.location.href = '/thank-you.html';
    },
    onClose: function(){
      alert("Payment was not completed.");
    }
  });
  handler.openIframe();
}

// Initialize cart on page load
updateCart();
</script>
