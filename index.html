<script>
// Load cart from localStorage (same as products.html)
let cart = JSON.parse(localStorage.getItem('hivarix_cart')) || [];
const cartCountSpan = document.getElementById('cart-count');
const cartPopup = document.getElementById('cart-popup');
const cartItemsDiv = document.getElementById('cart-items');

// Save cart to localStorage and update cart count
function updateCart() {
  localStorage.setItem('hivarix_cart', JSON.stringify(cart));
  let totalItems = cart.reduce((sum, item) => sum + item.qty, 0);
  cartCountSpan.textContent = totalItems;
  renderCartItems();
}

// Render cart items in popup
function renderCartItems() {
  cartItemsDiv.innerHTML = '';
  cart.forEach((item, index) => {
    const div = document.createElement('div');
    div.classList.add('cart-item');
    div.innerHTML = `${item.name} - NGN ${item.price.toLocaleString()} <button onclick="removeFromCart(${index})">x</button>`;
    cartItemsDiv.appendChild(div);
  });
}

// Add item to cart
function addToCart(id, name, price) {
  const existing = cart.find(i => i.id === id);
  if (existing) existing.qty++;
  else cart.push({ id, name, price, qty: 1 });
  updateCart();
}

// Remove item from cart
function removeFromCart(index) {
  cart.splice(index, 1);
  updateCart();
}

// Open/close cart popup
document.getElementById('cart-btn').addEventListener('click', () => {
  cartPopup.style.display = cartPopup.style.display === 'block' ? 'none' : 'block';
});
document.getElementById('close-cart-btn').addEventListener('click', () => {
  cartPopup.style.display = 'none';
});

// Checkout & Paystack
document.getElementById('checkout-form').addEventListener('submit', function(e) {
  e.preventDefault();
  if(cart.length === 0) { alert('Your cart is empty'); return; }

  const firstName = document.getElementById('firstName').value.trim();
  const lastName = document.getElementById('lastName').value.trim();
  const email = document.getElementById('email').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const nigeriaPhone = /^(?:0|\+234)[789][01]\d{8}$/;

  if (!firstName || !lastName || !email || !phone) { alert("Please fill all required fields."); return; }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { alert("Please enter a valid email."); return; }
  if (!nigeriaPhone.test(phone)) { alert("Please enter a valid Nigerian phone number."); return; }

  const totalAmount = cart.reduce((sum, item) => sum + item.price, 0);

  let handler = PaystackPop.setup({
    key: 'pk_live_532c5eee05f819c8589de72642aff146a75237dc',
    email: email,
    amount: totalAmount * 100,
    metadata: {
      custom_fields: [
        {display_name: "First Name", variable_name: "first_name", value: firstName},
        {display_name: "Last Name", variable_name: "last_name", value: lastName},
        {display_name: "Phone Number", variable_name: "phone", value: phone}
      ]
    },
    callback: function(response) {
      alert('Payment complete! Reference: ' + response.reference);
      cart = [];
      updateCart();
      cartPopup.style.display='none';
      document.getElementById('checkout-form').reset();
      window.location.href = '/thank-you.html';
    },
    onClose: function() {
      alert('Payment was not completed');
    }
  });
  handler.openIframe();
});

// Initialize cart on page load
updateCart();
</script>
