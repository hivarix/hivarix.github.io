<!-- CART POPUP -->
<div id="cart-popup">
  <h3>Your Cart</h3>
  <div id="cart-items"></div>
  <div class="cart-actions">
    <button id="checkout-btn">Checkout</button>
    <button id="close-cart-btn">Close</button>
  </div>
</div>

<!-- CHECKOUT FORM POPUP -->
<div id="checkout-form-popup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:20px; border-radius:10px; width:320px; box-shadow:0 4px 12px rgba(0,0,0,0.2); z-index:2000;">
  <h3>Checkout</h3>
  <form id="checkout-form">
    <label>First Name*:<br><input type="text" name="firstName" required></label><br><br>
    <label>Last Name*:<br><input type="text" name="lastName" required></label><br><br>
    <label>Email*:<br><input type="email" name="email" required></label><br><br>
    <label>Phone*:<br><input type="tel" name="phone" required placeholder="08012345678"></label><br><br>
    <button type="submit">Pay Now</button>
    <button type="button" id="cancel-checkout">Cancel</button>
  </form>
</div>

<script>
// Header sticky fix (already using position: sticky in CSS, ensure top:0)
const header = document.querySelector('nav');
header.style.position = 'sticky';
header.style.top = '0';
header.style.zIndex = '1000';

// Checkout popup handling
const checkoutBtn = document.getElementById('checkout-btn');
const checkoutPopup = document.getElementById('checkout-form-popup');
const cancelCheckout = document.getElementById('cancel-checkout');

checkoutBtn.addEventListener('click', () => {
  if(cart.length === 0) { alert('Your cart is empty'); return; }
  checkoutPopup.style.display = 'block';
});

cancelCheckout.addEventListener('click', () => {
  checkoutPopup.style.display = 'none';
});

// Form submission with validation
document.getElementById('checkout-form').addEventListener('submit', function(e){
  e.preventDefault();
  const form = e.target;
  const firstName = form.firstName.value.trim();
  const lastName = form.lastName.value.trim();
  const email = form.email.value.trim();
  const phone = form.phone.value.trim();

  const nigeriaPhoneRegex = /^(?:0|\+234)[789][01]\d{8}$/;
  if(!nigeriaPhoneRegex.test(phone)){
    alert("Please enter a valid Nigerian phone number (e.g., 08012345678 or +2348012345678).");
    return;
  }

  const total = cart.reduce((sum,item)=>sum+item.price,0);

  let handler = PaystackPop.setup({
    key: 'pk_live_532c5eee05f819c8589de72642aff146a75237dc',
    email: email,
    amount: total * 100,
    metadata: {
      custom_fields: [
        {display_name:"First Name", variable_name:"first_name", value:firstName},
        {display_name:"Last Name", variable_name:"last_name", value:lastName},
        {display_name:"Phone Number", variable_name:"phone", value:phone},
      ]
    },
    callback: function(response){
      alert('Payment complete! Reference: '+response.reference);
      cart = [];
      updateCart();
      checkoutPopup.style.display='none';
      cartPopup.style.display='none';
      window.location.href='/thank-you.html';
    },
    onClose: function(){
      alert('Payment was not completed.');
    }
  });
  handler.openIframe();
});
</script>
