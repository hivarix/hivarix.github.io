<script>
// -- Menu --
const menuBtn = document.getElementById('menu-btn');
const menuLinks = document.getElementById('menu-links');
menuBtn.addEventListener('click', e => { e.stopPropagation(); menuLinks.style.display = menuLinks.style.display === 'flex' ? 'none' : 'flex'; menuLinks.style.flexDirection = 'column'; });
document.addEventListener('click', e => { if(!menuLinks.contains(e.target) && e.target !== menuBtn){ menuLinks.style.display = 'none'; } });

// -- Unified Cart --
let cart = JSON.parse(localStorage.getItem('cart')) || [];
const cartCountSpan = document.getElementById('cart-count');
const cartBtn = document.getElementById('cart-btn');
const cartPopup = document.getElementById('cart-popup');
const cartItemsDiv = document.getElementById('cart-items');
const closeCartBtn = document.getElementById('close-cart-btn');

function updateCart() {
    localStorage.setItem('cart', JSON.stringify(cart));
    cartCountSpan.textContent = cart.length;
    cartItemsDiv.innerHTML = '';
    cart.forEach((item, index) => {
        const div = document.createElement('div');
        div.classList.add('cart-item');
        div.innerHTML = `${item.name} - NGN ${item.price} <button onclick="removeFromCart(${index})">x</button>`;
        cartItemsDiv.appendChild(div);
    });
}

// Remove item
function removeFromCart(index) {
    cart.splice(index, 1);
    updateCart();
}

// Add to cart buttons
document.querySelectorAll('.add-to-cart').forEach(btn => {
    btn.addEventListener('click', () => {
        const name = btn.getAttribute('data-name');
        const price = parseFloat(btn.getAttribute('data-price'));
        cart.push({name, price});
        updateCart();
        alert(`${name} added to cart`);
    });
});

// Show/hide cart popup
cartBtn.addEventListener('click', () => {
    cartPopup.style.display = cartPopup.style.display === 'block' ? 'none' : 'block';
});
closeCartBtn.addEventListener('click', () => {
    cartPopup.style.display = 'none';
});

// -- Checkout / Paystack --
const checkoutForm = document.getElementById('checkout-form');
checkoutForm.addEventListener('submit', e => {
    e.preventDefault();
    if(cart.length === 0){ alert('Cart is empty'); return; }

    const firstName = document.getElementById('firstName').value.trim();
    const lastName = document.getElementById('lastName').value.trim();
    const email = document.getElementById('email').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const nigeriaPhone = /^(?:0|\+234)[789][01]\d{8}$/;

    if(!firstName || !lastName || !email || !phone){ alert("Fill all required fields"); return; }
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ alert("Invalid email"); return; }
    if(!nigeriaPhone.test(phone)){ alert("Invalid Nigerian phone number"); return; }

    const total = cart.reduce((sum,item)=>sum+item.price,0);
    let handler = PaystackPop.setup({
        key:'pk_live_532c5eee05f819c8589de72642aff146a75237dc',
        email: email,
        amount: total*100,
        metadata:{custom_fields:[
            {display_name:"First Name",variable_name:"first_name",value:firstName},
            {display_name:"Last Name",variable_name:"last_name",value:lastName},
            {display_name:"Phone Number",variable_name:"phone",value:phone}
        ]},
        callback: function(response){
            alert('Payment complete! Reference: '+response.reference);
            cart = [];
            updateCart();
            cartPopup.style.display = 'none';
            checkoutForm.reset();
            window.location.href = '/thank-you.html';
        },
        onClose: function(){ alert('Payment was not completed'); }
    });
    handler.openIframe();
});

// Initialize cart on page load
updateCart();
</script>
